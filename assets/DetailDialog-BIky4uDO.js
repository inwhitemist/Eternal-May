import{c as V,R as l,h as se,j as e,i as re,D as le,B as d,X as ie,k as ce,l as oe,M as ne,P as de,m as he}from"./index-BasCRiea.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=V("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=V("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),ge=h=>h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),ue=80;function pe({open:h,event:a,admin:W,onClose:y,onEdit:F,onDelete:q,onImagePreview:k}){var $;const[G,N]=l.useState(null),[j,C]=l.useState(null),[S,E]=l.useState(!1),[x,T]=l.useState(!1),[X,M]=l.useState(!1),w=l.useRef(null),b=l.useRef(null);l.useEffect(()=>{let t=!1;if(N(null),C(null),!!(a!=null&&a.chatId))return E(!0),se.getChatMessages(a.chatId,a.chatFromId??void 0,a.chatToId??void 0).then(s=>{t||N(s.messages||[])}).catch(s=>{t||C((s==null?void 0:s.message)||"Не удалось загрузить переписку")}).finally(()=>{t||E(!1)}),()=>{t=!0}},[a==null?void 0:a.chatId,a==null?void 0:a.chatFromId,a==null?void 0:a.chatToId]),l.useEffect(()=>{T(!!(a!=null&&a.chatId))},[a==null?void 0:a.chatId]);const R=l.useCallback(t=>{const s=t.match(/(https?:\/\/\S+\.(?:png|jpe?g|gif|webp)(?:\?\S*)?)/gi);return s?s.map(r=>r.trim()):[]},[]),I=l.useCallback((t,s)=>{if(!s.length)return t.trim();let r=t;return s.forEach(c=>{const m=new RegExp(`(?:\\s*Фотография:?\\s*)?${ge(c)}`,"gi");r=r.replace(m," ")}),r.replace(/ {2,}/g," ").trim()},[]),g=G??[],A=g.length,J=A>ue,P=l.useMemo(()=>g.map(t=>{const s=R(t.text),r=I(t.text,s),c="1 прикреплённое сообщение",m="Запись на стене",D="Аудиозапись",z="Видеозапись",H=r.includes(c),L=r.includes(m),_=r.includes(D),v=r.includes(z),Q=r==="Стикер",Y=t.author==="Вы",p=(i,o,ee)=>i.reduce((n,f,te)=>{if(typeof f!="string"||!f.includes(o))return n.push(f),n;const U=f.split(o);return U.forEach((ae,O)=>{n.push(ae),O<U.length-1&&n.push(e.jsx("span",{className:"text-black/40 dark:text-white/40",children:o},`${t.id}-${ee}-${te}-${O}`))}),n},[]);let B=r;if(r&&(H||L||_||v)){let i=[r];H&&(i=p(i,c,"attachment")),L&&(i=p(i,m,"post")),_&&(i=p(i,D,"audio")),v&&(i=p(i,z,"video")),B=i}const Z=(s.length,"border-black/5 bg-white/95 dark:border-white/10 dark:bg-neutral-900/70");return e.jsxs("div",{className:`rounded-2xl border px-4 py-3 text-sm shadow-xs backdrop-blur-xs transition hover:shadow-md ${Z}`,style:{wordBreak:"break-word",overflowWrap:"anywhere",maxWidth:"100%"},children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 text-xs text-black/60 dark:text-white/60",children:[e.jsx("span",{className:`font-semibold ${Y?"text-emerald-600 dark:text-emerald-300":"text-black dark:text-white"}`,children:t.author}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-black/5 px-2 py-0.5 text-[11px] font-normal text-black/60 dark:bg-white/10 dark:text-white/70",children:[e.jsx(xe,{size:12,className:"opacity-70"}),re(t.datetime)]})]}),r&&e.jsx("p",{className:`mt-2 whitespace-pre-line text-[15px] leading-relaxed ${Q?"text-black/40 dark:text-white/40 italic":"text-black/80 dark:text-white/80"}`,style:{wordBreak:"break-word",overflowWrap:"anywhere"},children:B}),s.length>0&&e.jsx("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:s.map((i,o)=>e.jsxs("button",{type:"button",className:"group relative overflow-hidden rounded-2xl border border-emerald-500/20 bg-black/5 shadow-inner transition hover:border-emerald-500/40 focus:outline-hidden focus-visible:ring-2 focus-visible:ring-emerald-500/50",onClick:()=>k(i),children:[e.jsx("img",{src:i,alt:"Фото из переписки",className:"h-44 w-full cursor-zoom-in object-cover transition duration-300 group-hover:scale-[1.03]",loading:"lazy"}),e.jsx("span",{className:"pointer-events-none absolute bottom-2 right-2 rounded-full bg-black/70 px-2 py-0.5 text-xs text-white opacity-0 transition group-hover:opacity-100",children:"Открыть"})]},`${t.id}-${o}`))})]},t.id)}),[g,R,I,k]),K=l.useCallback(()=>{const t=w.current,s=b.current;if(!t||!s)return;const r=Math.max(s.offsetTop-16,0);t.scrollTo({top:r,behavior:"smooth"})},[]);l.useEffect(()=>{const t=w.current;if(!t)return;const s=()=>{if(!x||!b.current){M(!1);return}const r=b.current.offsetTop;M(t.scrollTop>r+200)};return s(),t.addEventListener("scroll",s),()=>{t.removeEventListener("scroll",s)}},[x,g.length]);const u=l.useMemo(()=>[{tint:"rgba(99, 102, 241, 0.08)",border:"rgba(99, 102, 241, 0.25)",accent:"rgba(99, 102, 241, 0.4)"},{tint:"rgba(16, 185, 129, 0.08)",border:"rgba(16, 185, 129, 0.25)",accent:"rgba(16, 185, 129, 0.45)"},{tint:"rgba(14, 165, 233, 0.08)",border:"rgba(14, 165, 233, 0.25)",accent:"rgba(14, 165, 233, 0.4)"},{tint:"rgba(249, 115, 22, 0.08)",border:"rgba(249, 115, 22, 0.25)",accent:"rgba(249, 115, 22, 0.4)"},{tint:"rgba(244, 114, 182, 0.08)",border:"rgba(244, 114, 182, 0.25)",accent:"rgba(244, 114, 182, 0.4)"},{tint:"rgba(163, 230, 53, 0.08)",border:"rgba(163, 230, 53, 0.25)",accent:"rgba(163, 230, 53, 0.45)"},{tint:"rgba(248, 113, 113, 0.08)",border:"rgba(248, 113, 113, 0.25)",accent:"rgba(248, 113, 113, 0.4)"},{tint:"rgba(59, 130, 246, 0.08)",border:"rgba(59, 130, 246, 0.25)",accent:"rgba(59, 130, 246, 0.4)"}],[]);return l.useCallback(t=>{if(!t)return u[0];let s=0;for(let c=0;c<t.length;c+=1)s=s*31+t.charCodeAt(c)|0;const r=Math.abs(s)%u.length;return u[r]},[u]),!h||!a?null:e.jsxs(le,{open:h,onClose:y,children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between gap-3 border-b border-black/10 bg-white/95 px-4 py-3 dark:border-white/10 dark:bg-neutral-900/95 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(be,{size:18})," ",a.title]}),e.jsx(d,{variant:"ghost",onClick:y,children:e.jsx(ie,{size:18})})]}),e.jsxs("div",{className:"flex max-h-[85vh] flex-col gap-3 overflow-y-auto p-4",ref:w,children:[e.jsxs("div",{className:"text-sm opacity-80",children:[e.jsx(oe,{className:"-mt-0.5 inline",size:14})," ",ce(a.date)]}),a.imageData&&e.jsx("div",{className:"overflow-hidden rounded-2xl border border-black/10 dark:border-white/10 shrink-0",children:e.jsx("img",{src:a.imageData,alt:a.title,className:"max-h-[30vh] w-full cursor-pointer object-contain",onClick:()=>k(a.imageData)})}),a.description&&e.jsx("p",{className:"text-sm leading-relaxed text-neutral-800 dark:text-neutral-200 whitespace-pre-line",children:a.description}),($=a.tags)!=null&&$.length?e.jsx("div",{className:"flex flex-wrap gap-2",children:a.tags.map(t=>e.jsxs("span",{className:"rounded-full border border-black/10 bg-black/5 px-2 py-0.5 text-xs dark:border-white/10 dark:bg-white/10",children:["#",t==="legendary"?"легендарное":t]},t))}):null,a.chatId&&e.jsxs("div",{className:"rounded-2xl border border-emerald-500/30 bg-emerald-500/5 p-3",ref:b,children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm font-semibold text-emerald-700 dark:text-emerald-200",children:[e.jsx(ne,{size:16})," Переписка",J&&e.jsxs("span",{className:"rounded-full border border-emerald-500/40 bg-emerald-500/10 px-2 py-0.5 text-[11px] font-medium text-emerald-700 dark:text-emerald-100",children:["Большая переписка · ",A]})]}),e.jsx(d,{variant:"ghost",className:"px-3 py-1 text-xs",onClick:()=>T(t=>!t),children:x?"Скрыть":"Показать"})]}),x?e.jsxs("div",{className:"mt-3 grid gap-2",children:[S&&e.jsx("div",{className:"text-sm text-black/60 dark:text-white/60",children:"Загрузка переписки…"}),j&&e.jsx("div",{className:"text-sm text-red-500",children:j}),!S&&!j&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("div",{className:"flex flex-col gap-3",children:P.length?P:e.jsx("div",{className:"text-sm text-black/60 dark:text-white/60",children:"Сообщений в указанном диапазоне нет"})}),X&&e.jsx("div",{className:"pointer-events-none sticky bottom-3 flex justify-end pr-1",children:e.jsx(d,{variant:"ghost",className:"pointer-events-auto rounded-full bg-white/90 px-4 py-2 text-xs font-semibold text-emerald-700 shadow-lg ring-1 ring-emerald-500/30 backdrop-blur-xs dark:bg-neutral-900/90 dark:text-emerald-100",onClick:K,children:"К началу"})})]})]}):e.jsx("div",{className:"mt-3 text-sm text-black/60 dark:text-white/60",children:"Переписка скрыта"})]}),W&&e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(d,{variant:"soft",onClick:()=>F(a),children:[e.jsx(de,{size:16})," Редактировать"]}),e.jsxs(d,{variant:"outline",onClick:()=>q(a),children:[e.jsx(he,{size:16})," Удалить"]})]})]})]})}export{pe as default};
