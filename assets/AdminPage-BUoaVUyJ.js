import{c as N,r as i,j as e,h as Y,i as K,B as c,L as Z,S as G,a as _,k as z,l as J,I as q,g as V,m as P,n as ee}from"./index-DCmzJbv5.js";import{C as B}from"./chevron-down-DT99vgdm.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=N("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=N("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=N("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=N("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=N("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=N("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);function re({authorized:m,isAdminUser:p,loadingProof:r,proofError:n,onExit:f,onRequestLogin:o,onRetryProof:u}){const[v,h]=i.useState("users");if(i.useEffect(()=>{h("users")},[m]),!m){const g=p?r?"Подтверждаем права администратора…":n?"Не удалось подтвердить права":"Нет доступа":"Эта страница только для админов",x=p?r?"Мы сверяем подписи и выдаём временный пропуск. Это займёт всего пару секунд.":n||"Нужно повторно подтвердить админскую сессию.":"Убедитесь, что вошли под админским аккаунтом. Если нужна помощь — свяжитесь с владельцем таймлайна.";return e.jsx("div",{className:"min-h-[100svh] bg-gradient-to-b from-slate-100 to-white px-4 py-10 dark:from-neutral-950 dark:to-neutral-900",children:e.jsxs("div",{className:"mx-auto flex min-h-[80svh] max-w-3xl flex-col items-center justify-center gap-6 text-center",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-black/10 bg-white/70 px-4 py-1 text-sm backdrop-blur dark:border-white/10 dark:bg-white/10",children:[r?e.jsx(Y,{size:16,className:"animate-spin"}):e.jsx(K,{size:16})," Доступ ограничен"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-3xl font-bold",children:g}),e.jsx("p",{className:"text-base text-black/70 dark:text-white/70",children:x}),n&&p&&!r&&e.jsx("p",{className:"text-sm text-rose-500",children:n})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-3",children:[o&&!p&&e.jsxs(c,{onClick:o,children:[e.jsx(Z,{size:16})," Войти"]}),p&&!r&&u&&e.jsxs(c,{variant:"soft",onClick:u,children:[e.jsx(U,{size:16})," Повторить проверку"]}),e.jsx(c,{variant:"outline",onClick:f,children:"Вернуться к воспоминаниям"})]})]})})}return e.jsx("div",{className:"min-h-[100svh] bg-gradient-to-b from-slate-50 to-white px-4 py-10 dark:from-neutral-900 dark:to-neutral-950",children:e.jsxs("div",{className:"mx-auto flex max-w-6xl flex-col gap-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"inline-flex items-center gap-2 rounded-full border border-black/10 bg-white/70 px-3 py-1 text-xs font-medium uppercase tracking-wide text-black/70 backdrop-blur dark:border-white/10 dark:bg-white/10 dark:text-white/70",children:[e.jsx(K,{size:14})," Secure Area"]}),e.jsx("h1",{className:"mt-3 text-3xl font-bold",children:"Админ-панель"}),e.jsx("p",{className:"text-black/60 dark:text-white/60",children:"Управляйте пользователями, кодами и легендарными событиями."})]}),e.jsx(c,{variant:"outline",onClick:f,children:"Вернуться к таймлайну"})]}),e.jsxs("div",{className:"rounded-3xl border border-black/5 bg-white/80 shadow-2xl shadow-purple-500/5 backdrop-blur dark:border-white/10 dark:bg-neutral-900/80",children:[e.jsxs("div",{className:"border-b border-black/5 px-4 pb-4 pt-6 dark:border-white/10",children:[e.jsx("div",{className:"flex flex-wrap items-center justify-between gap-3",children:e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(R,{size:18})," Контрольная панель"]})}),e.jsx("div",{className:"relative mt-4",children:e.jsxs("div",{className:"flex gap-2 rounded-xl bg-black/5 p-1 dark:bg-white/10",children:[e.jsxs(A,{active:v==="users",onClick:()=>h("users"),children:[e.jsx(R,{size:16})," Пользователи"]}),e.jsxs(A,{active:v==="legendary",onClick:()=>h("legendary"),children:[e.jsx(G,{size:16})," Легендарные события"]})]})})]}),e.jsx("div",{className:"p-4",children:v==="users"?e.jsx(ae,{}):e.jsx(te,{})})]})]})})}function A({active:m,onClick:p,children:r}){return e.jsx("button",{onClick:p,className:_("flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm transition",m?"bg-white shadow dark:bg-neutral-800":"hover:bg-black/10 dark:hover:bg-white/20"),children:r})}function ae(){const[m,p]=i.useState([]),[r,n]=i.useState(!1),[f,o]=i.useState(null),[u,v]=i.useState(""),[h,g]=i.useState("all"),[x,S]=i.useState("email"),[y,a]=i.useState("asc"),[j,w]=i.useState({}),[$,F]=i.useState(null),[k,T]=i.useState(null);i.useEffect(()=>{C()},[]);async function C(){o(null),n(!0);try{const s=await z.getUsers();p(s.users)}catch(s){o((s==null?void 0:s.message)||"Не удалось загрузить пользователей")}finally{n(!1)}}async function H(s){const t=(j[s]||"").trim();if(!t)return;const l=Array.from(new Set(t.split(/[\s,;]+/g).map(d=>d.trim()).filter(Boolean)));if(l.length!==0){n(!0),o(null);try{for(const d of l)await z.grantLegendary(s,d);w(d=>({...d,[s]:""})),await C()}catch(d){o((d==null?void 0:d.message)||"Не удалось выдать код(ы)")}finally{n(!1)}}}async function O(s,t){n(!0),o(null);try{await z.revokeLegendary(s,t),await C()}catch(l){o((l==null?void 0:l.message)||"Не удалось отозвать код")}finally{n(!1),T(null)}}async function W(s,t){if(t.length!==0){n(!0),o(null);try{for(const l of t)await z.revokeLegendary(s,l);await C()}catch(l){o((l==null?void 0:l.message)||"Не удалось отозвать коды")}finally{n(!1)}}}function D(s){x===s?a(t=>t==="asc"?"desc":"asc"):(S(s),a("asc"))}const Q=i.useMemo(()=>{const s=u.trim().toLowerCase();let t=m.filter(l=>{if(h!=="all"&&l.role!==h)return!1;if(!s)return!0;const d=l.email.toLowerCase().includes(s),b=l.codes.some(X=>X.toLowerCase().includes(s));return d||b||l.id.toLowerCase().includes(s)});return t.sort((l,d)=>{let b=0;return x==="email"?b=l.email.localeCompare(d.email):x==="role"?b=l.role.localeCompare(d.role):x==="codes"&&(b=l.codes.length-d.codes.length),y==="asc"?b:-b}),t},[m,u,h,x,y]);async function I(s,t){try{await navigator.clipboard.writeText(s),F(t),setTimeout(()=>F(l=>l===t?null:l),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(R,{size:16})," Управление пользователями"]}),e.jsxs(c,{variant:"soft",onClick:C,disabled:r,children:[e.jsx(U,{className:r?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(J,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(q,{value:u,onChange:s=>v(s.target.value),placeholder:"Поиск по email, id, коду",className:"pl-8"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:h==="all"?"soft":"outline",onClick:()=>g("all"),children:"Все"}),e.jsx(c,{variant:h==="admin"?"soft":"outline",onClick:()=>g("admin"),children:"Админы"}),e.jsx(c,{variant:h==="user"?"soft":"outline",onClick:()=>g("user"),children:"Пользователи"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-60",children:"Сортировка:"}),e.jsxs(c,{variant:"outline",onClick:()=>D("email"),className:"text-xs",children:["Email ",x==="email"?y==="asc"?e.jsx(E,{size:14}):e.jsx(B,{size:14}):null]}),e.jsxs(c,{variant:"outline",onClick:()=>D("role"),className:"text-xs",children:["Роль ",x==="role"?y==="asc"?e.jsx(E,{size:14}):e.jsx(B,{size:14}):null]}),e.jsxs(c,{variant:"outline",onClick:()=>D("codes"),className:"text-xs",children:["Кол-во кодов ",x==="codes"?y==="asc"?e.jsx(E,{size:14}):e.jsx(B,{size:14}):null]})]}),f&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:f}),e.jsx("div",{className:"grid gap-3",children:r&&m.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка пользователей…"}):Q.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):Q.map(s=>e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(se,{size:14,className:"opacity-60"})," ",s.email]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["ID: ",s.id]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["Роль: ",s.role]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(c,{variant:"outline",onClick:()=>I(s.email,`email:${s.id}`),children:[$===`email:${s.id}`?e.jsx(L,{size:14}):e.jsx(M,{size:14}),"Копировать email"]}),e.jsxs(c,{variant:"outline",onClick:()=>I(s.id,`id:${s.id}`),children:[$===`id:${s.id}`?e.jsx(L,{size:14}):e.jsx(M,{size:14}),"ID"]})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[s.codes.length===0&&e.jsx("span",{className:"text-xs opacity-60",children:"Кодов нет"}),s.codes.map(t=>e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-black/5 dark:bg-white/10 px-2 py-1 text-xs",children:[t,e.jsx("button",{onClick:()=>I(t,`code:${s.id}:${t}`),title:"Копировать код",className:"opacity-60 hover:opacity-100",children:$===`code:${s.id}:${t}`?e.jsx(L,{size:12}):e.jsx(M,{size:12})}),e.jsx("button",{onClick:()=>T({userId:s.id,code:t}),title:"Удалить код",className:"opacity-60 hover:opacity-100",children:e.jsx(V,{size:12})})]},t))]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(q,{value:j[s.id]||"",onChange:t=>w(l=>({...l,[s.id]:t.target.value})),onKeyDown:t=>{t.key==="Enter"&&H(s.id)},placeholder:"Код или несколько (через запятую/пробел)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:()=>H(s.id),disabled:r,children:[e.jsx(P,{size:16})," Выдать"]}),s.codes.length>0&&e.jsxs(c,{variant:"outline",onClick:()=>W(s.id,s.codes),disabled:r,children:[e.jsx(V,{size:16})," Удалить все"]})]})]})]},s.id))}),e.jsx(ee,{open:!!k,title:"Удалить код?",description:k?`Код ${k.code} будет отозван.`:void 0,confirmText:"Удалить",cancelText:"Отмена",onConfirm:()=>k&&O(k.userId,k.code),onCancel:()=>T(null)})]})}function te(){const[m,p]=i.useState([]),[r,n]=i.useState(!1),[f,o]=i.useState(null),[u,v]=i.useState(""),[h,g]=i.useState(null);i.useEffect(()=>{x()},[]);async function x(){n(!0),o(null);try{const a=await z.getLegendaryCatalog();p(a.catalog||[])}catch(a){o((a==null?void 0:a.message)||"Не удалось загрузить список кодов")}finally{n(!1)}}const S=i.useMemo(()=>{const a=u.trim().toLowerCase();return m.filter(j=>!a||j.code.toLowerCase().includes(a)||j.title.toLowerCase().includes(a)||(j.description||"").toLowerCase().includes(a))},[m,u]);async function y(a,j){try{await navigator.clipboard.writeText(a),g(j),setTimeout(()=>g(w=>w===j?null:w),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(G,{size:16})," Доступные к активации события"]}),e.jsxs(c,{variant:"soft",onClick:x,disabled:r,children:[e.jsx(U,{className:r?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(J,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(q,{value:u,onChange:a=>v(a.target.value),placeholder:"Поиск по коду или названию",className:"pl-8"})]}),f&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:f}),e.jsx("div",{className:"grid gap-3",children:r&&m.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка…"}):S.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):S.map(a=>e.jsx("div",{className:"rounded-xl border p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium flex items-center gap-2",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"rounded-md bg-yellow-500/15 px-2 py-0.5 text-xs text-yellow-700 dark:text-yellow-300",children:a.code}),e.jsx("span",{children:a.title})]})}),a.description?e.jsx("div",{className:"mt-1 text-xs opacity-80",children:a.description}):null,e.jsxs("div",{className:"mt-1 text-[11px] opacity-60",children:["Источник: ",a.source==="db"?"Событие в БД":"Встроено"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(c,{variant:"outline",onClick:()=>y(a.code,`code:${a.code}`),children:[h===`code:${a.code}`?e.jsx(L,{size:14}):e.jsx(M,{size:14}),"Код"]})})]})},`${a.source}:${a.code}`))})]})}export{re as default};
