import{c as L,r as a,j as e,D as X,B as x,U as P,S as O,M as Q,a as Y,f as z,l as V,I as D,k as J,m as Z,n as _,F as ee}from"./index-B5ZeHfn4.js";import{C as F}from"./chevron-down-dk-osCQY.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=L("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=L("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=L("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=L("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=L("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=L("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);function ce({open:d,onClose:j}){const[n,c]=a.useState("users");return a.useEffect(()=>{d&&c("users")},[d]),e.jsx(X,{open:d,onClose:j,children:e.jsxs("div",{className:"p-0 flex max-h-[85vh] flex-col",children:[e.jsxs("div",{className:"border-b px-4 pt-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 pb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(te,{size:18})," Админ-панель"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:j,children:"Закрыть"})})]}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex gap-2 rounded-xl bg-black/5 p-1 dark:bg-white/10",children:[e.jsxs(q,{active:n==="users",onClick:()=>c("users"),children:[e.jsx(P,{size:16})," Пользователи"]}),e.jsxs(q,{active:n==="legendary",onClick:()=>c("legendary"),children:[e.jsx(O,{size:16})," Легендарные события"]}),e.jsxs(q,{active:n==="chats",onClick:()=>c("chats"),children:[e.jsx(Q,{size:16})," Переписки"]})]})})]}),e.jsx("div",{className:"min-h-0 flex-1 overflow-y-auto p-4",children:n==="users"?e.jsx(ae,{}):n==="legendary"?e.jsx(ie,{}):e.jsx(le,{})})]})})}function q({active:d,onClick:j,children:n}){return e.jsx("button",{onClick:j,className:Y("flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm transition",d?"bg-white shadow dark:bg-neutral-800":"hover:bg-black/10 dark:hover:bg-white/20"),children:n})}function ae(){const[d,j]=a.useState([]),[n,c]=a.useState(!1),[w,p]=a.useState(null),[y,k]=a.useState(""),[g,f]=a.useState("all"),[m,b]=a.useState("email"),[N,t]=a.useState("asc"),[v,h]=a.useState({}),[r,C]=a.useState(null),[u,$]=a.useState(null);a.useEffect(()=>{M()},[]);async function M(){p(null),c(!0);try{const s=await z.getUsers();j(s.users)}catch(s){p((s==null?void 0:s.message)||"Не удалось загрузить пользователей")}finally{c(!1)}}async function A(s){const l=(v[s]||"").trim();if(!l)return;const i=Array.from(new Set(l.split(/[\s,;]+/g).map(o=>o.trim()).filter(Boolean)));if(i.length!==0){c(!0),p(null);try{for(const o of i)await z.grantLegendary(s,o);h(o=>({...o,[s]:""})),await M()}catch(o){p((o==null?void 0:o.message)||"Не удалось выдать код(ы)")}finally{c(!1)}}}async function K(s,l){c(!0),p(null);try{await z.revokeLegendary(s,l),await M()}catch(i){p((i==null?void 0:i.message)||"Не удалось отозвать код")}finally{c(!1),$(null)}}async function G(s,l){if(l.length!==0){c(!0),p(null);try{for(const i of l)await z.revokeLegendary(s,i);await M()}catch(i){p((i==null?void 0:i.message)||"Не удалось отозвать коды")}finally{c(!1)}}}function T(s){m===s?t(l=>l==="asc"?"desc":"asc"):(b(s),t("asc"))}const B=a.useMemo(()=>{const s=y.trim().toLowerCase();let l=d.filter(i=>{if(g!=="all"&&i.role!==g)return!1;if(!s)return!0;const o=i.email.toLowerCase().includes(s),S=i.codes.some(W=>W.toLowerCase().includes(s));return o||S||i.id.toLowerCase().includes(s)});return l.sort((i,o)=>{let S=0;return m==="email"?S=i.email.localeCompare(o.email):m==="role"?S=i.role.localeCompare(o.role):m==="codes"&&(S=i.codes.length-o.codes.length),N==="asc"?S:-S}),l},[d,y,g,m,N]);async function U(s,l){try{await navigator.clipboard.writeText(s),C(l),setTimeout(()=>C(i=>i===l?null:i),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(P,{size:16})," Управление пользователями"]}),e.jsxs(x,{variant:"soft",onClick:M,disabled:n,children:[e.jsx(H,{className:n?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(V,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(D,{value:y,onChange:s=>k(s.target.value),placeholder:"Поиск по email, id, коду",className:"pl-8"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:g==="all"?"soft":"outline",onClick:()=>f("all"),children:"Все"}),e.jsx(x,{variant:g==="admin"?"soft":"outline",onClick:()=>f("admin"),children:"Админы"}),e.jsx(x,{variant:g==="user"?"soft":"outline",onClick:()=>f("user"),children:"Пользователи"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-60",children:"Сортировка:"}),e.jsxs(x,{variant:"outline",onClick:()=>T("email"),className:"text-xs",children:["Email ",m==="email"?N==="asc"?e.jsx(R,{size:14}):e.jsx(F,{size:14}):null]}),e.jsxs(x,{variant:"outline",onClick:()=>T("role"),className:"text-xs",children:["Роль ",m==="role"?N==="asc"?e.jsx(R,{size:14}):e.jsx(F,{size:14}):null]}),e.jsxs(x,{variant:"outline",onClick:()=>T("codes"),className:"text-xs",children:["Кол-во кодов ",m==="codes"?N==="asc"?e.jsx(R,{size:14}):e.jsx(F,{size:14}):null]})]}),w&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:w}),e.jsx("div",{className:"grid gap-3",children:n&&d.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка пользователей…"}):B.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):B.map(s=>e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(se,{size:14,className:"opacity-60"})," ",s.email]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["ID: ",s.id]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["Роль: ",s.role]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(x,{variant:"outline",onClick:()=>U(s.email,`email:${s.id}`),children:[r===`email:${s.id}`?e.jsx(E,{size:14}):e.jsx(I,{size:14}),"Копировать email"]}),e.jsxs(x,{variant:"outline",onClick:()=>U(s.id,`id:${s.id}`),children:[r===`id:${s.id}`?e.jsx(E,{size:14}):e.jsx(I,{size:14}),"ID"]})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[s.codes.length===0&&e.jsx("span",{className:"text-xs opacity-60",children:"Кодов нет"}),s.codes.map(l=>e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-black/5 dark:bg-white/10 px-2 py-1 text-xs",children:[l,e.jsx("button",{onClick:()=>U(l,`code:${s.id}:${l}`),title:"Копировать код",className:"opacity-60 hover:opacity-100",children:r===`code:${s.id}:${l}`?e.jsx(E,{size:12}):e.jsx(I,{size:12})}),e.jsx("button",{onClick:()=>$({userId:s.id,code:l}),title:"Удалить код",className:"opacity-60 hover:opacity-100",children:e.jsx(J,{size:12})})]},l))]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(D,{value:v[s.id]||"",onChange:l=>h(i=>({...i,[s.id]:l.target.value})),onKeyDown:l=>{l.key==="Enter"&&A(s.id)},placeholder:"Код или несколько (через запятую/пробел)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>A(s.id),disabled:n,children:[e.jsx(Z,{size:16})," Выдать"]}),s.codes.length>0&&e.jsxs(x,{variant:"outline",onClick:()=>G(s.id,s.codes),disabled:n,children:[e.jsx(J,{size:16})," Удалить все"]})]})]})]},s.id))}),e.jsx(_,{open:!!u,title:"Удалить код?",description:u?`Код ${u.code} будет отозван.`:void 0,confirmText:"Удалить",cancelText:"Отмена",onConfirm:()=>u&&K(u.userId,u.code),onCancel:()=>$(null)})]})}function le(){const[d,j]=a.useState(""),[n,c]=a.useState([]),[w,p]=a.useState(null),[y,k]=a.useState(null),[g,f]=a.useState(null),[m,b]=a.useState(!1);function N(h){try{const r=JSON.parse(h);if(!Array.isArray(r))throw new Error("Файл должен содержать массив сообщений");const C=r.map(u=>({id:Number(u.id),datetime:String(u.datetime||""),author:String(u.author||""),text:String(u.text||"")}));c(C),k(`Загружено сообщений: ${C.length}`),f(null)}catch(r){c([]),k(null),f((r==null?void 0:r.message)||"Не удалось разобрать JSON")}}function t(h){var u;const r=(u=h.target.files)==null?void 0:u[0];if(!r)return;p(r.name);const C=new FileReader;C.onload=()=>{if(N(String(C.result)),!d){const $=r.name.replace(/\.json$/i,"");j($)}},C.readAsText(r,"utf-8")}async function v(){const h=d.trim();if(!h){f("Укажите ID чата");return}if(!n.length){f("Добавьте файл переписки");return}b(!0),f(null),k(null);try{const r=await z.uploadChatLog(h,n);k(`Файл сохранён (${r.messages} сообщений)`)}catch(r){f((r==null?void 0:r.message)||"Не удалось загрузить файл")}finally{b(!1)}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(Q,{size:16})," Загрузка переписок (JSON)"]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs text-black/60 dark:text-white/60",children:"ID чата (имя файла без .json)"}),e.jsx(D,{value:d,onChange:h=>j(h.target.value),placeholder:"samir"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs text-black/60 dark:text-white/60",children:"Файл переписки (.json)"}),e.jsx(D,{type:"file",accept:"application/json,.json",onChange:t}),w&&e.jsxs("div",{className:"text-xs text-black/60 dark:text-white/60",children:["Выбран файл: ",w]})]}),y&&e.jsx("div",{className:"text-sm text-emerald-600 dark:text-emerald-300",children:y}),g&&e.jsx("div",{className:"text-sm text-red-500",children:g}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(x,{onClick:v,disabled:m,children:[e.jsx(ee,{size:16})," ",m?"Сохранение…":"Сохранить переписку"]})})]})}function ie(){const[d,j]=a.useState([]),[n,c]=a.useState(!1),[w,p]=a.useState(null),[y,k]=a.useState(""),[g,f]=a.useState(null);a.useEffect(()=>{m()},[]);async function m(){c(!0),p(null);try{const t=await z.getLegendaryCatalog();j(t.catalog||[])}catch(t){p((t==null?void 0:t.message)||"Не удалось загрузить список кодов")}finally{c(!1)}}const b=a.useMemo(()=>{const t=y.trim().toLowerCase();return d.filter(v=>!t||v.code.toLowerCase().includes(t)||v.title.toLowerCase().includes(t)||(v.description||"").toLowerCase().includes(t))},[d,y]);async function N(t,v){try{await navigator.clipboard.writeText(t),f(v),setTimeout(()=>f(h=>h===v?null:h),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(O,{size:16})," Доступные к активации события"]}),e.jsxs(x,{variant:"soft",onClick:m,disabled:n,children:[e.jsx(H,{className:n?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(D,{value:y,onChange:t=>k(t.target.value),placeholder:"Поиск по коду или названию",className:"pl-8"})]}),w&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:w}),e.jsx("div",{className:"grid gap-3",children:n&&d.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка…"}):b.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):b.map(t=>e.jsx("div",{className:"rounded-xl border p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium flex items-center gap-2",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"rounded-md bg-yellow-500/15 px-2 py-0.5 text-xs text-yellow-700 dark:text-yellow-300",children:t.code}),e.jsx("span",{children:t.title})]})}),t.description?e.jsx("div",{className:"mt-1 text-xs opacity-80",children:t.description}):null,e.jsxs("div",{className:"mt-1 text-[11px] opacity-60",children:["Источник: ",t.source==="db"?"Событие в БД":"Встроено"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(x,{variant:"outline",onClick:()=>N(t.code,`code:${t.code}`),children:[g===`code:${t.code}`?e.jsx(E,{size:14}):e.jsx(I,{size:14}),"Код"]})})]})},`${t.source}:${t.code}`))})]})}export{ce as default};
