import{c as $,r as i,j as e,D as te,B as d,U as H,S as K,M as G,a as ae,h as z,n as W,I as E,m as q,T,d as V,o as le,p as _,F as ie}from"./index-BasCRiea.js";import{C as B}from"./chevron-down-Ba448hpT.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=$("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=$("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=$("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=$("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=$("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=$("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);function he({open:o,onClose:j}){const[r,n]=i.useState("users");return i.useEffect(()=>{o&&n("users")},[o]),e.jsx(te,{open:o,onClose:j,children:e.jsxs("div",{className:"p-0 flex max-h-[85vh] flex-col",children:[e.jsxs("div",{className:"border-b px-4 pt-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 pb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ne,{size:18})," Админ-панель"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(d,{variant:"outline",onClick:j,children:"Закрыть"})})]}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex gap-2 rounded-xl bg-black/5 p-1 dark:bg-white/10",children:[e.jsxs(P,{active:r==="users",onClick:()=>n("users"),children:[e.jsx(H,{size:16})," Пользователи"]}),e.jsxs(P,{active:r==="legendary",onClick:()=>n("legendary"),children:[e.jsx(K,{size:16})," Легендарные события"]}),e.jsxs(P,{active:r==="chats",onClick:()=>n("chats"),children:[e.jsx(G,{size:16})," Переписки"]})]})})]}),e.jsx("div",{className:"min-h-0 flex-1 overflow-y-auto p-4",children:r==="users"?e.jsx(ce,{}):r==="legendary"?e.jsx(de,{}):e.jsx(oe,{})})]})})}function P({active:o,onClick:j,children:r}){return e.jsx("button",{onClick:j,className:ae("flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm transition",o?"bg-white shadow-sm dark:bg-neutral-800":"hover:bg-black/10 dark:hover:bg-white/20"),children:r})}function ce(){const[o,j]=i.useState([]),[r,n]=i.useState(!1),[w,x]=i.useState(null),[y,k]=i.useState(""),[g,f]=i.useState("all"),[h,b]=i.useState("email"),[N,a]=i.useState("asc"),[v,u]=i.useState({}),[c,C]=i.useState(null),[p,M]=i.useState(null),[D,I]=i.useState(null);i.useEffect(()=>{L()},[]);async function L(){x(null),n(!0);try{const s=await z.getUsers();j(s.users)}catch(s){x((s==null?void 0:s.message)||"Не удалось загрузить пользователей")}finally{n(!1)}}async function O(s){const t=(v[s]||"").trim();if(!t)return;const l=Array.from(new Set(t.split(/[\s,;]+/g).map(m=>m.trim()).filter(Boolean)));if(l.length!==0){n(!0),x(null);try{for(const m of l)await z.grantLegendary(s,m);u(m=>({...m,[s]:""})),await L()}catch(m){x((m==null?void 0:m.message)||"Не удалось выдать код(ы)")}finally{n(!1)}}}async function Y(s,t){n(!0),x(null);try{await z.revokeLegendary(s,t),await L()}catch(l){x((l==null?void 0:l.message)||"Не удалось отозвать код")}finally{n(!1),M(null)}}async function Z(s,t){if(t.length!==0){n(!0),x(null);try{for(const l of t)await z.revokeLegendary(s,l);await L()}catch(l){x((l==null?void 0:l.message)||"Не удалось отозвать коды")}finally{n(!1)}}}async function ee(s){n(!0),x(null);try{await z.deleteUser(s),await L()}catch(t){const l=(t==null?void 0:t.message)==="cannot_delete_self"?"Нельзя удалить свой аккаунт":t==null?void 0:t.message;x(l||"Не удалось удалить пользователя")}finally{n(!1),I(null)}}function F(s){h===s?a(t=>t==="asc"?"desc":"asc"):(b(s),a("asc"))}const Q=i.useMemo(()=>{const s=y.trim().toLowerCase();let t=o.filter(l=>{if(g!=="all"&&l.role!==g)return!1;if(!s)return!0;const m=l.email.toLowerCase().includes(s),S=l.codes.some(se=>se.toLowerCase().includes(s));return m||S||l.id.toLowerCase().includes(s)});return t.sort((l,m)=>{let S=0;return h==="email"?S=l.email.localeCompare(m.email):h==="role"?S=l.role.localeCompare(m.role):h==="codes"&&(S=l.codes.length-m.codes.length),N==="asc"?S:-S}),t},[o,y,g,h,N]);async function R(s,t){try{await navigator.clipboard.writeText(s),C(t),setTimeout(()=>C(l=>l===t?null:l),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(H,{size:16})," Управление пользователями"]}),e.jsxs(d,{variant:"soft",onClick:L,disabled:r,children:[e.jsx(X,{className:r?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(W,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(E,{value:y,onChange:s=>k(s.target.value),placeholder:"Поиск по email, id, коду",className:"pl-8"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:g==="all"?"soft":"outline-solid",onClick:()=>f("all"),children:"Все"}),e.jsx(d,{variant:g==="admin"?"soft":"outline-solid",onClick:()=>f("admin"),children:"Админы"}),e.jsx(d,{variant:g==="user"?"soft":"outline-solid",onClick:()=>f("user"),children:"Пользователи"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-60",children:"Сортировка:"}),e.jsxs(d,{variant:"outline",onClick:()=>F("email"),className:"text-xs",children:["Email ",h==="email"?N==="asc"?e.jsx(J,{size:14}):e.jsx(B,{size:14}):null]}),e.jsxs(d,{variant:"outline",onClick:()=>F("role"),className:"text-xs",children:["Роль ",h==="role"?N==="asc"?e.jsx(J,{size:14}):e.jsx(B,{size:14}):null]}),e.jsxs(d,{variant:"outline",onClick:()=>F("codes"),className:"text-xs",children:["Кол-во кодов ",h==="codes"?N==="asc"?e.jsx(J,{size:14}):e.jsx(B,{size:14}):null]})]}),w&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:w}),e.jsx("div",{className:"grid gap-3",children:r&&o.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка пользователей…"}):Q.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):Q.map(s=>e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(re,{size:14,className:"opacity-60"})," ",s.email]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["ID: ",s.id]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["Роль: ",s.role]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(d,{variant:"outline",onClick:()=>R(s.email,`email:${s.id}`),children:[c===`email:${s.id}`?e.jsx(U,{size:14}):e.jsx(A,{size:14}),"Копировать email"]}),e.jsxs(d,{variant:"outline",onClick:()=>R(s.id,`id:${s.id}`),children:[c===`id:${s.id}`?e.jsx(U,{size:14}):e.jsx(A,{size:14}),"ID"]}),e.jsxs(d,{variant:"outline",className:"border-red-200 text-red-600 dark:border-red-500/30 dark:text-red-300",onClick:()=>I(s),disabled:r,children:[e.jsx(q,{size:14})," Удалить"]})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[s.codes.length===0&&e.jsx("span",{className:"text-xs opacity-60",children:"Кодов нет"}),s.codes.map(t=>e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-black/5 dark:bg-white/10 px-2 py-1 text-xs",children:[t,e.jsxs(T,{delay:0,children:[e.jsx(T.Trigger,{asChild:!0,children:e.jsx("button",{onClick:()=>R(t,`code:${s.id}:${t}`),className:"opacity-60 hover:opacity-100",children:c===`code:${s.id}:${t}`?e.jsx(U,{size:12}):e.jsx(A,{size:12})})}),e.jsxs(V,{showArrow:!0,className:"text-xs text-center",children:[e.jsx(T.Arrow,{}),"Копировать код"]})]}),e.jsxs(T,{delay:0,children:[e.jsx(T.Trigger,{asChild:!0,children:e.jsx("button",{onClick:()=>M({userId:s.id,code:t}),className:"opacity-60 hover:opacity-100",children:e.jsx(q,{size:12})})}),e.jsxs(V,{showArrow:!0,className:"text-xs text-center",children:[e.jsx(T.Arrow,{}),"Удалить код"]})]})]},t))]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(E,{value:v[s.id]||"",onChange:t=>u(l=>({...l,[s.id]:t.target.value})),onKeyDown:t=>{t.key==="Enter"&&O(s.id)},placeholder:"Код или несколько (через запятую/пробел)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:()=>O(s.id),disabled:r,children:[e.jsx(le,{size:16})," Выдать"]}),s.codes.length>0&&e.jsxs(d,{variant:"outline",onClick:()=>Z(s.id,s.codes),disabled:r,children:[e.jsx(q,{size:16})," Удалить все"]})]})]})]},s.id))}),e.jsx(_,{open:!!p,title:"Удалить код?",description:p?`Код ${p.code} будет отозван.`:void 0,confirmText:"Удалить",cancelText:"Отмена",onConfirm:()=>p&&Y(p.userId,p.code),onCancel:()=>M(null)}),e.jsx(_,{open:!!D,title:"Удалить пользователя?",description:D?`Будут удалены аккаунт ${D.email}, все выданные ему коды и созданные события.`:void 0,confirmText:"Удалить",cancelText:"Отмена",onConfirm:()=>D&&ee(D.id),onCancel:()=>I(null)})]})}function oe(){const[o,j]=i.useState(""),[r,n]=i.useState([]),[w,x]=i.useState(null),[y,k]=i.useState(null),[g,f]=i.useState(null),[h,b]=i.useState(!1);function N(u){try{const c=JSON.parse(u);if(!Array.isArray(c))throw new Error("Файл должен содержать массив сообщений");const C=c.map(p=>({id:Number(p.id),datetime:String(p.datetime||""),author:String(p.author||""),text:String(p.text||"")}));n(C),k(`Загружено сообщений: ${C.length}`),f(null)}catch(c){n([]),k(null),f((c==null?void 0:c.message)||"Не удалось разобрать JSON")}}function a(u){var p;const c=(p=u.target.files)==null?void 0:p[0];if(!c)return;x(c.name);const C=new FileReader;C.onload=()=>{if(N(String(C.result)),!o){const M=c.name.replace(/\.json$/i,"");j(M)}},C.readAsText(c,"utf-8")}async function v(){const u=o.trim();if(!u){f("Укажите ID чата");return}if(!r.length){f("Добавьте файл переписки");return}b(!0),f(null),k(null);try{const c=await z.uploadChatLog(u,r);k(`Файл сохранён (${c.messages} сообщений)`)}catch(c){f((c==null?void 0:c.message)||"Не удалось загрузить файл")}finally{b(!1)}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(G,{size:16})," Загрузка переписок (JSON)"]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs text-black/60 dark:text-white/60",children:"ID чата (имя файла без .json)"}),e.jsx(E,{value:o,onChange:u=>j(u.target.value),placeholder:"samir"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-xs text-black/60 dark:text-white/60",children:"Файл переписки (.json)"}),e.jsx(E,{type:"file",accept:"application/json,.json",onChange:a}),w&&e.jsxs("div",{className:"text-xs text-black/60 dark:text-white/60",children:["Выбран файл: ",w]})]}),y&&e.jsx("div",{className:"text-sm text-emerald-600 dark:text-emerald-300",children:y}),g&&e.jsx("div",{className:"text-sm text-red-500",children:g}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(d,{onClick:v,disabled:h,children:[e.jsx(ie,{size:16})," ",h?"Сохранение…":"Сохранить переписку"]})})]})}function de(){const[o,j]=i.useState([]),[r,n]=i.useState(!1),[w,x]=i.useState(null),[y,k]=i.useState(""),[g,f]=i.useState(null);i.useEffect(()=>{h()},[]);async function h(){n(!0),x(null);try{const a=await z.getLegendaryCatalog();j(a.catalog||[])}catch(a){x((a==null?void 0:a.message)||"Не удалось загрузить список кодов")}finally{n(!1)}}const b=i.useMemo(()=>{const a=y.trim().toLowerCase();return o.filter(v=>!a||v.code.toLowerCase().includes(a)||v.title.toLowerCase().includes(a)||(v.description||"").toLowerCase().includes(a))},[o,y]);async function N(a,v){try{await navigator.clipboard.writeText(a),f(v),setTimeout(()=>f(u=>u===v?null:u),1200)}catch{}}return e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm opacity-60",children:[e.jsx(K,{size:16})," Доступные к активации события"]}),e.jsxs(d,{variant:"soft",onClick:h,disabled:r,children:[e.jsx(X,{className:r?"animate-spin":"",size:16})," Обновить"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(E,{value:y,onChange:a=>k(a.target.value),placeholder:"Поиск по коду или названию",className:"pl-8"})]}),w&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:w}),e.jsx("div",{className:"grid gap-3",children:r&&o.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка…"}):b.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):b.map(a=>e.jsx("div",{className:"rounded-xl border p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium flex items-center gap-2",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"rounded-md bg-yellow-500/15 px-2 py-0.5 text-xs text-yellow-700 dark:text-yellow-300",children:a.code}),e.jsx("span",{children:a.title})]})}),a.description?e.jsx("div",{className:"mt-1 text-xs opacity-80",children:a.description}):null,e.jsxs("div",{className:"mt-1 text-[11px] opacity-60",children:["Источник: ",a.source==="db"?"Событие в БД":"Встроено"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(d,{variant:"outline",onClick:()=>N(a.code,`code:${a.code}`),children:[g===`code:${a.code}`?e.jsx(U,{size:14}):e.jsx(A,{size:14}),"Код"]})})]})},`${a.source}:${a.code}`))})]})}export{he as default};
