import{c as L,R as i,f as te,j as e,D as ae,B as d,X as se,g as re,h as le,M as ie,i as ce,P as oe,k as ne}from"./index-B8tvFqHt.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=L("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=L("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),xe=h=>h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),be=80;function me({open:h,event:t,admin:B,onClose:j,onEdit:_,onDelete:U,onImagePreview:w}){var T;const[O,y]=i.useState(null),[p,N]=i.useState(null),[C,E]=i.useState(!1),[f,S]=i.useState(!1),[V,W]=i.useState(!1),k=i.useRef(null);i.useEffect(()=>{let a=!1;if(y(null),N(null),!!(t!=null&&t.chatId))return E(!0),te.getChatMessages(t.chatId,t.chatFromId??void 0,t.chatToId??void 0).then(s=>{a||y(s.messages||[])}).catch(s=>{a||N((s==null?void 0:s.message)||"Не удалось загрузить переписку")}).finally(()=>{a||E(!1)}),()=>{a=!0}},[t==null?void 0:t.chatId,t==null?void 0:t.chatFromId,t==null?void 0:t.chatToId]),i.useEffect(()=>{S(!!(t!=null&&t.chatId))},[t==null?void 0:t.chatId]);const F=i.useCallback(a=>{const s=a.match(/(https?:\/\/\S+\.(?:png|jpe?g|gif|webp)(?:\?\S*)?)/gi);return s?s.map(r=>r.trim()):[]},[]),q=i.useCallback((a,s)=>{if(!s.length)return a.trim();let r=a;return s.forEach(c=>{const g=new RegExp(`(?:\\s*Фотография:?\\s*)?${xe(c)}`,"gi");r=r.replace(g," ")}),r.replace(/ {2,}/g," ").trim()},[]),x=O??[],I=x.length,G=I>be,X=i.useCallback(a=>{const s=k.current;if(!s)return;const r=a==="start"?0:s.scrollHeight;s.scrollTo({top:r,behavior:"smooth"})},[]);i.useEffect(()=>{const a=k.current;if(!a)return;const s=()=>{W(a.scrollTop>200)};return s(),a.addEventListener("scroll",s),()=>{a.removeEventListener("scroll",s)}},[f,x.length]);const b=i.useMemo(()=>[{tint:"rgba(99, 102, 241, 0.08)",border:"rgba(99, 102, 241, 0.25)",accent:"rgba(99, 102, 241, 0.4)"},{tint:"rgba(16, 185, 129, 0.08)",border:"rgba(16, 185, 129, 0.25)",accent:"rgba(16, 185, 129, 0.45)"},{tint:"rgba(14, 165, 233, 0.08)",border:"rgba(14, 165, 233, 0.25)",accent:"rgba(14, 165, 233, 0.4)"},{tint:"rgba(249, 115, 22, 0.08)",border:"rgba(249, 115, 22, 0.25)",accent:"rgba(249, 115, 22, 0.4)"},{tint:"rgba(244, 114, 182, 0.08)",border:"rgba(244, 114, 182, 0.25)",accent:"rgba(244, 114, 182, 0.4)"},{tint:"rgba(163, 230, 53, 0.08)",border:"rgba(163, 230, 53, 0.25)",accent:"rgba(163, 230, 53, 0.45)"},{tint:"rgba(248, 113, 113, 0.08)",border:"rgba(248, 113, 113, 0.25)",accent:"rgba(248, 113, 113, 0.4)"},{tint:"rgba(59, 130, 246, 0.08)",border:"rgba(59, 130, 246, 0.25)",accent:"rgba(59, 130, 246, 0.4)"}],[]);return i.useCallback(a=>{if(!a)return b[0];let s=0;for(let c=0;c<a.length;c+=1)s=s*31+a.charCodeAt(c)|0;const r=Math.abs(s)%b.length;return b[r]},[b]),!h||!t?null:e.jsxs(ae,{open:h,onClose:j,children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between gap-3 border-b border-black/10 bg-white/95 px-4 py-3 dark:border-white/10 dark:bg-neutral-900/95 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(he,{size:18})," ",t.title]}),e.jsx(d,{variant:"ghost",onClick:j,children:e.jsx(se,{size:18})})]}),e.jsxs("div",{className:"flex max-h-[85vh] flex-col gap-3 overflow-y-auto p-4",children:[e.jsxs("div",{className:"text-sm opacity-80",children:[e.jsx(le,{className:"-mt-0.5 inline",size:14})," ",re(t.date)]}),t.imageData&&e.jsx("div",{className:"overflow-hidden rounded-2xl border border-black/10 dark:border-white/10 flex-shrink-0",children:e.jsx("img",{src:t.imageData,alt:t.title,className:"max-h-[30vh] w-full cursor-pointer object-contain",onClick:()=>w(t.imageData)})}),t.description&&e.jsx("p",{className:"text-sm leading-relaxed text-neutral-800 dark:text-neutral-200 whitespace-pre-line",children:t.description}),(T=t.tags)!=null&&T.length?e.jsx("div",{className:"flex flex-wrap gap-2",children:t.tags.map(a=>e.jsxs("span",{className:"rounded-full border border-black/10 bg-black/5 px-2 py-0.5 text-xs dark:border-white/10 dark:bg-white/10",children:["#",a==="legendary"?"легендарное":a]},a))}):null,t.chatId&&e.jsxs("div",{className:"rounded-2xl border border-emerald-500/30 bg-emerald-500/5 p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm font-semibold text-emerald-700 dark:text-emerald-200",children:[e.jsx(ie,{size:16})," Переписка",G&&e.jsxs("span",{className:"rounded-full border border-emerald-500/40 bg-emerald-500/10 px-2 py-0.5 text-[11px] font-medium text-emerald-700 dark:text-emerald-100",children:["Большая переписка · ",I]})]}),e.jsx(d,{variant:"ghost",className:"px-3 py-1 text-xs",onClick:()=>S(a=>!a),children:f?"Скрыть":"Показать"})]}),f?e.jsxs("div",{className:"mt-3 grid gap-2",children:[C&&e.jsx("div",{className:"text-sm text-black/60 dark:text-white/60",children:"Загрузка переписки…"}),p&&e.jsx("div",{className:"text-sm text-red-500",children:p}),!C&&!p&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"flex max-h-[55vh] flex-col gap-3 overflow-y-auto pr-1",ref:k,children:x.length?x.map(a=>{const s=F(a.text),r=q(a.text,s),c="1 прикреплённое сообщение",g="Запись на стене",M="Аудиозапись",P="Видеозапись",R=r.includes(c),A=r.includes(g),$=r.includes(M),D=r.includes(P),J=r==="Стикер",K=a.author==="Вы",m=(l,o,Y)=>l.reduce((n,u,Z)=>{if(typeof u!="string"||!u.includes(o))return n.push(u),n;const H=u.split(o);return H.forEach((ee,v)=>{n.push(ee),v<H.length-1&&n.push(e.jsx("span",{className:"text-black/40 dark:text-white/40",children:o},`${a.id}-${Y}-${Z}-${v}`))}),n},[]);let z=r;if(r&&(R||A||$||D)){let l=[r];R&&(l=m(l,c,"attachment")),A&&(l=m(l,g,"post")),$&&(l=m(l,M,"audio")),D&&(l=m(l,P,"video")),z=l}const Q=(s.length,"border-black/5 bg-white/95 dark:border-white/10 dark:bg-neutral-900/70");return e.jsxs("div",{className:`rounded-2xl border px-4 py-3 text-sm shadow-sm backdrop-blur-sm transition hover:shadow-md ${Q}`,style:{wordBreak:"break-word",overflowWrap:"anywhere",maxWidth:"100%"},children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 text-xs text-black/60 dark:text-white/60",children:[e.jsx("span",{className:`font-semibold ${K?"text-emerald-600 dark:text-emerald-300":"text-black dark:text-white"}`,children:a.author}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-black/5 px-2 py-0.5 text-[11px] font-normal text-black/60 dark:bg-white/10 dark:text-white/70",children:[e.jsx(de,{size:12,className:"opacity-70"}),ce(a.datetime)]})]}),r&&e.jsx("p",{className:`mt-2 whitespace-pre-line text-[15px] leading-relaxed ${J?"text-black/40 dark:text-white/40 italic":"text-black/80 dark:text-white/80"}`,style:{wordBreak:"break-word",overflowWrap:"anywhere"},children:z}),s.length>0&&e.jsx("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:s.map((l,o)=>e.jsxs("button",{type:"button",className:"group relative overflow-hidden rounded-2xl border border-emerald-500/20 bg-black/5 shadow-inner transition hover:border-emerald-500/40 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/50",onClick:()=>w(l),children:[e.jsx("img",{src:l,alt:"Фото из переписки",className:"h-44 w-full cursor-zoom-in object-cover transition duration-300 group-hover:scale-[1.03]",loading:"lazy"}),e.jsx("span",{className:"pointer-events-none absolute bottom-2 right-2 rounded-full bg-black/70 px-2 py-0.5 text-xs text-white opacity-0 transition group-hover:opacity-100",children:"Открыть"})]},`${a.id}-${o}`))})]},a.id)}):e.jsx("div",{className:"text-sm text-black/60 dark:text-white/60",children:"Сообщений в указанном диапазоне нет"})}),V&&e.jsx("div",{className:"pointer-events-none absolute bottom-3 right-3",children:e.jsx(d,{variant:"ghost",className:"pointer-events-auto rounded-full bg-white/90 px-4 py-2 text-xs font-semibold text-emerald-700 shadow-lg ring-1 ring-emerald-500/30 backdrop-blur-sm dark:bg-neutral-900/90 dark:text-emerald-100",onClick:()=>X("start"),children:"К началу"})})]})]}):e.jsx("div",{className:"mt-3 text-sm text-black/60 dark:text-white/60",children:"Переписка скрыта"})]}),B&&e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(d,{variant:"soft",onClick:()=>_(t),children:[e.jsx(oe,{size:16})," Редактировать"]}),e.jsxs(d,{variant:"outline",onClick:()=>U(t),children:[e.jsx(ne,{size:16})," Удалить"]})]})]})]})}export{me as default};
