import{c as x,r as l,e as u,j as e,D as G,B as n,g as J,I as q,d as A,h as O,i as W}from"./index-CgvB4RSR.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=x("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const b=x("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=x("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=x("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=x("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=x("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=x("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);function ee({open:y,onClose:M}){const[v,F]=l.useState([]),[f,r]=l.useState(!1),[$,c]=l.useState(null),[g,V]=l.useState(""),[m,C]=l.useState("all"),[o,H]=l.useState("email"),[p,E]=l.useState("asc"),[R,B]=l.useState({}),[k,I]=l.useState(null),[h,w]=l.useState(null);l.useEffect(()=>{y&&j()},[y]);async function j(){c(null),r(!0);try{const s=await u.getUsers();F(s.users)}catch(s){c((s==null?void 0:s.message)||"Не удалось загрузить пользователей")}finally{r(!1)}}async function T(s){const a=(R[s]||"").trim();if(!a)return;const t=Array.from(new Set(a.split(/[\s,;]+/g).map(i=>i.trim()).filter(Boolean)));if(t.length!==0){r(!0),c(null);try{for(const i of t)await u.grantLegendary(s,i);B(i=>({...i,[s]:""})),await j()}catch(i){c((i==null?void 0:i.message)||"Не удалось выдать код(ы)")}finally{r(!1)}}}async function K(s,a){r(!0),c(null);try{await u.revokeLegendary(s,a),await j()}catch(t){c((t==null?void 0:t.message)||"Не удалось отозвать код")}finally{r(!1),w(null)}}async function P(s,a){if(a.length!==0){r(!0),c(null);try{for(const t of a)await u.revokeLegendary(s,t);await j()}catch(t){c((t==null?void 0:t.message)||"Не удалось отозвать коды")}finally{r(!1)}}}function N(s){o===s?E(a=>a==="asc"?"desc":"asc"):(H(s),E("asc"))}const U=l.useMemo(()=>{const s=g.trim().toLowerCase();let a=v.filter(t=>{if(m!=="all"&&t.role!==m)return!1;if(!s)return!0;const i=t.email.toLowerCase().includes(s),d=t.codes.some(Q=>Q.toLowerCase().includes(s));return i||d||t.id.toLowerCase().includes(s)});return a.sort((t,i)=>{let d=0;return o==="email"?d=t.email.localeCompare(i.email):o==="role"?d=t.role.localeCompare(i.role):o==="codes"&&(d=t.codes.length-i.codes.length),p==="asc"?d:-d}),a},[v,g,m,o,p]);async function z(s,a){try{await navigator.clipboard.writeText(s),I(a),setTimeout(()=>I(t=>t===a?null:t),1200)}catch{}}return e.jsx(G,{open:y,onClose:M,children:e.jsxs("div",{className:"p-6 w-[92vw] max-w-2xl max-h-[80vh] overflow-y-auto grid gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Z,{size:18})," Пользователи"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(n,{variant:"soft",onClick:j,disabled:f,children:[e.jsx(Y,{className:f?"animate-spin":"",size:16}),"Обновить"]}),e.jsx(n,{variant:"outline",onClick:M,children:"Закрыть"})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(J,{size:14,className:"absolute left-3 top-1/2 -translate-y-1/2 opacity-60"}),e.jsx(q,{value:g,onChange:s=>V(s.target.value),placeholder:"Поиск по email, id, коду",className:"pl-8"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{variant:m==="all"?"soft":"outline",onClick:()=>C("all"),children:"Все"}),e.jsx(n,{variant:m==="admin"?"soft":"outline",onClick:()=>C("admin"),children:"Админы"}),e.jsx(n,{variant:m==="user"?"soft":"outline",onClick:()=>C("user"),children:"Пользователи"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-60",children:"Сортировка:"}),e.jsxs(n,{variant:"outline",onClick:()=>N("email"),className:"text-xs",children:["Email ",o==="email"?p==="asc"?e.jsx(L,{size:14}):e.jsx(b,{size:14}):null]}),e.jsxs(n,{variant:"outline",onClick:()=>N("role"),className:"text-xs",children:["Роль ",o==="role"?p==="asc"?e.jsx(L,{size:14}):e.jsx(b,{size:14}):null]}),e.jsxs(n,{variant:"outline",onClick:()=>N("codes"),className:"text-xs",children:["Кол-во кодов ",o==="codes"?p==="asc"?e.jsx(L,{size:14}):e.jsx(b,{size:14}):null]})]}),$&&e.jsx("div",{className:"rounded-xl border border-red-300/40 bg-red-500/10 px-3 py-2 text-sm text-red-600 dark:border-red-500/20 dark:text-red-300",children:$}),e.jsx("div",{className:"grid gap-3",children:f&&v.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Загрузка пользователей…"}):U.length===0?e.jsx("div",{className:"text-sm opacity-60",children:"Ничего не найдено"}):U.map(s=>e.jsxs("div",{className:"border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(X,{size:14,className:"opacity-60"})," ",s.email]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["ID: ",s.id]}),e.jsxs("div",{className:"mt-1 text-xs opacity-60",children:["Роль: ",s.role]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(n,{variant:"outline",onClick:()=>z(s.email,`email:${s.id}`),children:[k===`email:${s.id}`?e.jsx(S,{size:14}):e.jsx(D,{size:14}),"Копировать email"]}),e.jsxs(n,{variant:"outline",onClick:()=>z(s.id,`id:${s.id}`),children:[k===`id:${s.id}`?e.jsx(S,{size:14}):e.jsx(D,{size:14}),"ID"]})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[s.codes.length===0&&e.jsx("span",{className:"text-xs opacity-60",children:"Кодов нет"}),s.codes.map(a=>e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-black/5 dark:bg-white/10 px-2 py-1 text-xs",children:[a,e.jsx("button",{onClick:()=>z(a,`code:${s.id}:${a}`),title:"Копировать код",className:"opacity-60 hover:opacity-100",children:k===`code:${s.id}:${a}`?e.jsx(S,{size:12}):e.jsx(D,{size:12})}),e.jsx("button",{onClick:()=>w({userId:s.id,code:a}),title:"Удалить код",className:"opacity-60 hover:opacity-100",children:e.jsx(A,{size:12})})]},a))]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(q,{value:R[s.id]||"",onChange:a=>B(t=>({...t,[s.id]:a.target.value})),onKeyDown:a=>{a.key==="Enter"&&T(s.id)},placeholder:"Код или несколько (через запятую/пробел)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{onClick:()=>T(s.id),disabled:f,children:[e.jsx(O,{size:16})," Выдать"]}),s.codes.length>0&&e.jsxs(n,{variant:"outline",onClick:()=>P(s.id,s.codes),disabled:f,children:[e.jsx(A,{size:16})," Удалить все"]})]})]})]},s.id))}),e.jsx(W,{open:!!h,title:"Удалить код?",description:h?`Код ${h.code} будет отозван.`:void 0,confirmText:"Удалить",cancelText:"Отмена",onConfirm:()=>h&&K(h.userId,h.code),onCancel:()=>w(null)})]})})}export{ee as default};
